<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ArcGIS Data Enrichment App - Tapestry Segmentation</title>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .header p {
      margin: 0.5rem 0 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 400px;
      background: white;
      border-right: 1px solid #e1e5e9;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-content {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .input-section {
      margin-bottom: 2rem;
    }

    .input-section h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #555;
    }

    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .map-container {
      flex: 1;
      position: relative;
    }

    .results-section {
      margin-top: 2rem;
    }

    .results-section h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }

    .tapestry-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
      display: none;
    }

    .tapestry-card.active {
      display: block;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .zip-code {
      background: #667eea;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .demographics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .demographic-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .demographic-item h4 {
      color: #667eea;
      margin: 0 0 0.5rem 0;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .demographic-item .value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }

    .tapestry-segments {
      margin-top: 1rem;
    }

    .tapestry-segments h4 {
      color: #667eea;
      margin: 0 0 1rem 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .segment-item {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      border-left: 3px solid #667eea;
    }

    .segment-item h5 {
      margin: 0 0 0.25rem 0;
      font-size: 0.9rem;
      color: #333;
    }

    .segment-item p {
      margin: 0;
      font-size: 0.8rem;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid #c33;
      margin-bottom: 1rem;
      display: none;
    }

    .error.active {
      display: block;
    }

    .info-box {
      background: #e3f2fd;
      color: #1976d2;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 300px;
      }
      
      .map-container {
        height: 400px;
      }

      .demographics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

      <script>
      var esriConfig = {
        apiKey: "AAPT85fOqywZsicJupSmVSCGrhwxbRrmDP89Tr8jhIl2ka6wFYHD5U8QTHcRMCoBLPxtmd4ZZsi1qAu93ffXFVNJ2dEDmuUhqvdbo4ipgwNszTk3wtO873AO7638UOZstZ1EZ_sqvIyVCuqvdSBD5GKp3HJo1Ds3AgNWGC08ZxyPEUJBaoxVdCiQqy988YY5FRVZpPQuhowsndy7Bz5O38mMaH4Qug_wWGrqwL2MOkNF7Evr3SV4xr-nFD7MBIzD6SkJAT2_VQn5OsAR"
      };
    </script>

  <!-- Load Calcite components from CDN -->
  <script type="module" src="https://js.arcgis.com/calcite-components/3.2.1/calcite.esm.js"></script>

  <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.33/"></script>

  <!-- Load Map components from CDN-->
  <script type="module" src="https://js.arcgis.com/4.33/map-components/"></script>
</head>

<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <h1>üó∫Ô∏è ArcGIS Data Enrichment App</h1>
      <p>Enter a ZIP code to get Tapestry segmentation and demographic data</p>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-content">
          <!-- Input Section -->
          <div class="input-section">
            <h2>üìç ZIP Code Analysis</h2>
            <div class="info-box">
              <strong>How it works:</strong> Enter a US ZIP code to get detailed demographic and Tapestry segmentation data for that area.
            </div>
            
            <div class="input-group">
              <label for="zipCodeInput">ZIP Code:</label>
              <input 
                type="text" 
                id="zipCodeInput" 
                placeholder="Enter ZIP code (e.g., 90210)"
                maxlength="5"
                pattern="[0-9]{5}"
              />
            </div>
            
            <button id="analyzeBtn" class="btn">Analyze ZIP Code</button>
            <button id="testMapBtn" class="btn" style="margin-top: 10px; background: #28a745;">Test Map Centering</button>
          </div>

          <!-- Results Section -->
          <div class="results-section">
            <h2>üìä Analysis Results</h2>
            
            <!-- Loading State -->
            <div id="loadingState" class="loading" style="display: none;">
              <div class="spinner"></div>
              <p>Analyzing ZIP code...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error">
              <strong>Error:</strong> <span id="errorMessage"></span>
            </div>

            <!-- Results Card -->
            <div id="resultsCard" class="tapestry-card">
              <div class="card-header">
                <h3 class="card-title">Tapestry Segmentation</h3>
                <span id="zipCodeDisplay" class="zip-code">ZIP</span>
              </div>

              <!-- Demographics -->
              <div class="demographics-grid">
                <div class="demographic-item">
                  <h4>Total Population</h4>
                  <div id="totalPopulation" class="value">-</div>
                </div>
                <div class="demographic-item">
                  <h4>Median Age</h4>
                  <div id="medianAge" class="value">-</div>
                </div>
                <div class="demographic-item">
                  <h4>Median Income</h4>
                  <div id="medianIncome" class="value">-</div>
                </div>
                <div class="demographic-item">
                  <h4>Home Ownership</h4>
                  <div id="homeOwnership" class="value">-</div>
                </div>
              </div>

              <!-- Tapestry Segments -->
              <div class="tapestry-segments">
                <h4>Tapestry Segments</h4>
                <div id="tapestrySegments">
                  <p style="color: #666; font-style: italic;">Enter a ZIP code to see Tapestry segmentation data</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
             <!-- Map Container -->
       <div class="map-container">
        <arcgis-map basemap="arcgis/topographic" center="-118.805, 34.027" zoom="13">

          <arcgis-zoom position="top-left"></arcgis-zoom>
    
        </arcgis-map>
         
         <!-- Fallback message if map doesn't load -->
         
       </div>
    </div>
  </div>

  <!-- Simple JavaScript for ZIP code analysis -->
  <script>
    // Check if ArcGIS is loaded
    console.log('ArcGIS Config:', esriConfig);
    console.log('ArcGIS API loaded:', typeof require !== 'undefined');
    
    // Check if Map Components are available
    setTimeout(() => {
      console.log('Map Components available:', typeof customElements !== 'undefined' && customElements.get('arcgis-map'));
      const mapElement = document.querySelector('arcgis-map');
      console.log('Map element found:', mapElement);
      if (mapElement) {
        console.log('Map element tag name:', mapElement.tagName);
        console.log('Map element attributes:', mapElement.attributes);
        console.log('Map element view:', mapElement.view);
        console.log('Map element ready:', mapElement.ready);
        
        // Check if map is actually visible
        const rect = mapElement.getBoundingClientRect();
        console.log('Map dimensions:', rect.width, 'x', rect.height);
        
        if (rect.width === 0 || rect.height === 0) {
          console.log('Map has no dimensions, showing fallback');
          document.getElementById('mapFallback').style.display = 'block';
        }
        
        // Listen for map ready event
        mapElement.addEventListener('arcgisViewReadyChange', (event) => {
          console.log('Map view ready event:', event);
          console.log('Map view:', mapElement.view);
          
          // Show map ready status
          const testBtn = document.getElementById('testMapBtn');
          if (testBtn) {
            testBtn.textContent = '‚úÖ Map Ready - Test Centering';
            testBtn.style.background = '#28a745';
          }
        });
        
        // Check if map is already ready
        if (mapElement.view) {
          const testBtn = document.getElementById('testMapBtn');
          if (testBtn) {
            testBtn.textContent = '‚úÖ Map Ready - Test Centering';
            testBtn.style.background = '#28a745';
          }
        }
      } else {
        console.log('Map element not found, showing fallback');
        document.getElementById('mapFallback').style.display = 'block';
      }
    }, 3000);
    
    // DOM elements
    const zipCodeInput = document.getElementById('zipCodeInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');
    const resultsCard = document.getElementById('resultsCard');
    const zipCodeDisplay = document.getElementById('zipCodeDisplay');
    const totalPopulation = document.getElementById('totalPopulation');
    const medianAge = document.getElementById('medianAge');
    const medianIncome = document.getElementById('medianIncome');
    const homeOwnership = document.getElementById('homeOwnership');
    const tapestrySegments = document.getElementById('tapestrySegments');

    // Event listeners
    analyzeBtn.addEventListener('click', analyzeZipCode);
    zipCodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyzeZipCode();
    });
    
    // Test map centering
    document.getElementById('testMapBtn').addEventListener('click', async () => {
      console.log('Testing map centering...');
      await waitForMapReady();
      
      const mapElement = document.querySelector('arcgis-map');
      if (mapElement && mapElement.view) {
        console.log('Testing map centering to Los Angeles...');
        await mapElement.view.goTo({
          target: { longitude: -118.2437, latitude: 34.0522 },
          zoom: 10
        });
        console.log('Map centering test completed');
      } else {
        console.error('Map not available for testing');
      }
    });

    // Analyze ZIP code function
    async function analyzeZipCode() {
      const zipCode = zipCodeInput.value.trim();
      
      // Validate ZIP code
      if (!zipCode) {
        showError('Please enter a ZIP code');
        return;
      }
      
      if (!/^\d{5}$/.test(zipCode)) {
        showError('Please enter a valid 5-digit ZIP code');
        return;
      }
      
      // Show loading state
      showLoading();
      hideError();
      hideResults();
      
      try {
        console.log('Analyzing ZIP code:', zipCode);
        
        // Get demographic data
        const data = await getDemographicData(zipCode);
        
        if (data && data.length > 0) {
          const zipData = data[0];
          console.log('ZIP code data:', zipData);
          
          // Display results
          displayResults(zipCode, zipData);
          showResults();
        } else {
          showError('No data found for this ZIP code');
        }
        
      } catch (error) {
        console.error('Error analyzing ZIP code:', error);
        showError('Error fetching data. Please try again.');
      } finally {
        hideLoading();
      }
    }

    // Get demographic data from ArcGIS GeoEnrichment service
    async function getDemographicData(zipCode) {
      const url = 'https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver/Geoenrichment/enrich';
      
      const requestBody = {
        studyAreas: [{
          sourceCountry: "US",
          layer: "US.ZIP5",
          ids: [zipCode]
        }],
        dataCollections: [
          "KeyUSFacts",
          "US.TapestrySegmentation"
        ],
        returnGeometry: false,
        f: "json"
      };
      
      console.log('Making GeoEnrichment request:', requestBody);
      
      // Add API key to the URL
      const urlWithKey = `${url}?token=${esriConfig.apiKey}`;
      
      const response = await fetch(urlWithKey, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('GeoEnrichment response:', result);
      
      if (result.error) {
        throw new Error(result.error.message || 'GeoEnrichment service error');
      }
      
      return result.results || [];
    }

    // Display results
    function displayResults(zipCode, data) {
      // Update ZIP code display
      zipCodeDisplay.textContent = zipCode;
      
      // Update demographics
      totalPopulation.textContent = formatNumber(data.TOTPOP || 'N/A');
      medianAge.textContent = data.MEDIAN_AGE || data.AGE_MEDIAN || 'N/A';
      medianIncome.textContent = formatCurrency(data.MEDIAN_HOUSEHOLD_INCOME || data.INCOME_MEDIAN || 'N/A');
      homeOwnership.textContent = formatPercentage(data.HOME_OWNERSHIP_RATE || data.OWNERSHIP_RATE || 'N/A');
      
      // Update Tapestry segments
      displayTapestrySegments(data);
      
      // Center map on ZIP code location
      centerMapOnZipCode(zipCode);
    }

    // Display Tapestry segments
    function displayTapestrySegments(data) {
      const tapestryFields = Object.keys(data).filter(key => 
        key.includes('Tapestry') || key.includes('Segmentation') || key.includes('Segment')
      );
      
      if (tapestryFields.length > 0) {
        const segmentsHtml = tapestryFields.map(field => {
          const value = data[field];
          if (value && typeof value === 'string' && value.trim() !== '') {
            return `
              <div class="segment-item">
                <h5>${formatFieldName(field)}</h5>
                <p>${value}</p>
              </div>
            `;
          }
          return '';
        }).join('');
        
        tapestrySegments.innerHTML = segmentsHtml;
      } else {
        tapestrySegments.innerHTML = `
          <div class="segment-item">
            <h5>Demographic Analysis</h5>
            <p>Based on available demographic data for this ZIP code</p>
          </div>
        `;
      }
    }

    // Utility functions
    function formatNumber(num) {
      if (num === 'N/A' || num === null || num === undefined) return 'N/A';
      return new Intl.NumberFormat().format(num);
    }

    function formatCurrency(amount) {
      if (amount === 'N/A' || amount === null || amount === undefined) return 'N/A';
      if (typeof amount === 'string') return amount;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function formatPercentage(value) {
      if (value === 'N/A' || value === null || value === undefined) return 'N/A';
      if (typeof value === 'string') return value;
      return value.toFixed(1) + '%';
    }

    function formatFieldName(fieldName) {
      return fieldName
        .replace(/_/g, ' ')
        .replace(/([A-Z])/g, ' $1')
        .replace(/^./, str => str.toUpperCase())
        .trim();
    }

    // UI state management
    function showLoading() {
      loadingState.style.display = 'block';
      analyzeBtn.disabled = true;
    }

    function hideLoading() {
      loadingState.style.display = 'none';
      analyzeBtn.disabled = false;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorState.classList.add('active');
    }

    function hideError() {
      errorState.classList.remove('active');
    }

    function showResults() {
      resultsCard.classList.add('active');
    }

    function hideResults() {
      resultsCard.classList.remove('active');
    }

    // Wait for map to be ready
    async function waitForMapReady() {
      return new Promise((resolve) => {
        const mapElement = document.querySelector('arcgis-map');
        
        if (mapElement && mapElement.view) {
          console.log('Map is already ready');
          resolve();
          return;
        }
        
        console.log('Waiting for map to be ready...');
        
        // Check every 100ms for up to 10 seconds
        let attempts = 0;
        const maxAttempts = 100;
        
        const checkMap = () => {
          attempts++;
          const mapElement = document.querySelector('arcgis-map');
          
          console.log(`Map check attempt ${attempts}:`, {
            element: !!mapElement,
            view: !!mapElement?.view,
            ready: mapElement?.ready
          });
          
          if (mapElement && mapElement.view) {
            console.log('Map is now ready!');
            resolve();
            return;
          }
          
          if (attempts >= maxAttempts) {
            console.warn('Map did not become ready within timeout');
            resolve();
            return;
          }
          
          setTimeout(checkMap, 100);
        };
        
        checkMap();
      });
    }

    // Center map on ZIP code location
    async function centerMapOnZipCode(zipCode) {
      try {
        console.log('Centering map on ZIP code:', zipCode);
        
        // Get ZIP code coordinates using geocoding
        const geocodeUrl = 'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates';
        const params = new URLSearchParams({
          f: 'json',
          singleLine: zipCode,
          outFields: '*',
          maxLocations: 1,
          token: esriConfig.apiKey
        });
        
        const response = await fetch(`${geocodeUrl}?${params.toString()}`);
        const data = await response.json();
        
        console.log('Geocoding response:', data);
        
        if (data.candidates && data.candidates.length > 0) {
          const candidate = data.candidates[0];
          const location = {
            longitude: candidate.location.x,
            latitude: candidate.location.y
          };
          
          console.log('ZIP code location found:', location);
          
          // Wait for map to be ready and then center it
          await waitForMapReady();
          
          // Get the map view from the arcgis-map element
          const mapElement = document.querySelector('arcgis-map');
          console.log('Map element found for centering:', mapElement);
          console.log('Map element view:', mapElement?.view);
          
          if (mapElement && mapElement.view) {
            // Center map on location
            await mapElement.view.goTo({
              target: location,
              zoom: 12
            });
            
            console.log('Map centered on ZIP code location');
            
            // Add a marker at the ZIP code location
            addZipCodeMarker(location, zipCode);
          } else {
            console.warn('Map view not available for centering');
            console.log('Map element properties:', {
              tagName: mapElement?.tagName,
              attributes: mapElement?.attributes,
              view: mapElement?.view,
              ready: mapElement?.ready
            });
          }
        } else {
          console.warn('Could not find coordinates for ZIP code:', zipCode);
        }
      } catch (error) {
        console.error('Error centering map on ZIP code:', error);
      }
    }

    // Add a marker at the ZIP code location
    async function addZipCodeMarker(location, zipCode) {
      try {
        console.log('Adding marker for ZIP code:', zipCode, 'at location:', location);
        
        // Import required modules for creating graphics
        const { Point } = await import('https://js.arcgis.com/4.33/@arcgis/core/geometry/Point.js');
        const { Graphic } = await import('https://js.arcgis.com/4.33/@arcgis/core/Graphic.js');
        const { SimpleMarkerSymbol } = await import('https://js.arcgis.com/4.33/@arcgis/core/symbols/SimpleMarkerSymbol.js');
        const { TextSymbol } = await import('https://js.arcgis.com/4.33/@arcgis/core/symbols/TextSymbol.js');
        
        // Get the map view
        const mapElement = document.querySelector('arcgis-map');
        if (mapElement && mapElement.view) {
          // Clear existing graphics
          mapElement.view.graphics.removeAll();
          
          // Create a point geometry
          const point = new Point({
            longitude: location.longitude,
            latitude: location.latitude
          });
          
          // Create a marker symbol
          const markerSymbol = new SimpleMarkerSymbol({
            color: [102, 126, 234, 0.8], // Blue color with transparency
            size: 12,
            outline: {
              color: [255, 255, 255],
              width: 2
            }
          });
          
          // Create a text symbol for the ZIP code
          const textSymbol = new TextSymbol({
            color: [255, 255, 255],
            text: zipCode,
            font: {
              size: 12,
              weight: 'bold'
            },
            haloColor: [102, 126, 234],
            haloSize: 1,
            yoffset: -20
          });
          
          // Create graphics
          const markerGraphic = new Graphic({
            geometry: point,
            symbol: markerSymbol
          });
          
          const textGraphic = new Graphic({
            geometry: point,
            symbol: textSymbol
          });
          
          // Add graphics to the map
          mapElement.view.graphics.add(markerGraphic);
          mapElement.view.graphics.add(textGraphic);
          
          console.log('Marker added successfully');
        }
      } catch (error) {
        console.error('Error adding marker:', error);
      }
    }
  </script>
</body>
</html>
