<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ArcGIS Data Enrichment App - Tapestry Segmentation</title>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
      }

      .header p {
        margin: 0.5rem 0 0 0;
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      .sidebar {
        width: 400px;
        background: white;
        border-right: 1px solid #e1e5e9;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-content {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
      }

      .input-section {
        margin-bottom: 2rem;
      }

      .input-section h2 {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
      }

      .input-group {
        margin-bottom: 1rem;
      }

      .input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #555;
      }

      .input-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .map-container {
        flex: 1;
        position: relative;
      }

      .results-section {
        margin-top: 2rem;
      }

      .results-section h2 {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
      }

      .tapestry-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
        display: none;
      }

      .tapestry-card.active {
        display: block;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
        margin: 0;
      }

      .zip-code {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .demographics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .demographic-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
      }

      .demographic-item h4 {
        color: #667eea;
        margin: 0 0 0.5rem 0;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .demographic-item .value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
      }

      .tapestry-segments {
        margin-top: 1rem;
      }

      .tapestry-segments h4 {
        color: #667eea;
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .segment-item {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #667eea;
      }

      .segment-item h5 {
        margin: 0 0 0.25rem 0;
        font-size: 0.9rem;
        color: #333;
      }

      .segment-item p {
        margin: 0;
        font-size: 0.8rem;
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #c33;
        margin-bottom: 1rem;
        display: none;
      }

      .error.active {
        display: block;
      }

      .info-box {
        background: #e3f2fd;
        color: #1976d2;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #1976d2;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }
        
        .sidebar {
          width: 100%;
          height: auto;
          max-height: 300px;
        }
        
        .map-container {
          height: 400px;
        }

        .demographics-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <script>
      var esriConfig = {
        apiKey: "AAPTxy8BH1VEsoebNVZXo8HurHudtAypLm328sIJojSUcoWK4iawKp87GbOMcJ3USNJwbndtRPTvMP12Xu8gplWdFxyarXcZvh-Wi0yEb2PjnVog6aVtAPW_PJVrt1yU5FoDf4nM4Fa8hNK9FKRtBWb5h6L-KsYUy-_YYZiNWkKSEGwec1YXJfisQ7ES5SI1DIUWDQw_fbU5d7Dr2xKCHOrwBZAOpNZOF4Cyh06brHeismavZ0bmp3qv2hHvt-ShN2FnAT1_VQn5OsAR",
      };
    </script>

    <!-- Load Calcite components from CDN -->
    <script type="module" src="https://js.arcgis.com/calcite-components/3.2.1/calcite.esm.js"></script>

    <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.33/"></script>

    <!-- Load Map components from CDN-->
    <script type="module" src="https://js.arcgis.com/4.33/map-components/"></script>

  </head>

  <body>
    <div class="app-container">
      <!-- Header -->
      <div class="header">
        <h1>üó∫Ô∏è ArcGIS Data Enrichment App</h1>
        <p>Enter a ZIP code to get Tapestry segmentation and demographic data</p>
      </div>
      
      <!-- Main Content -->
      <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="sidebar-content">
            <!-- Input Section -->
            <div class="input-section">
              <h2>üìç ZIP Code Analysis</h2>
              <div class="info-box">
                <strong>How it works:</strong> Enter a US ZIP code to get detailed demographic and Tapestry segmentation data for that area.
              </div>
              
              <div class="input-group">
                <label for="zipCodeInput">ZIP Code:</label>
                <input 
                  type="text" 
                  id="zipCodeInput" 
                  placeholder="Enter ZIP code (e.g., 90210)"
                  maxlength="5"
                  pattern="[0-9]{5}"
                />
              </div>
              
              <button id="analyzeBtn" class="btn">Analyze ZIP Code</button>
            </div>

            <!-- Results Section -->
            <div class="results-section">
              <h2>ÔøΩÔøΩ Analysis Results</h2>
              
              <!-- Loading State -->
              <div id="loadingState" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Analyzing ZIP code...</p>
              </div>

              <!-- Error State -->
              <div id="errorState" class="error">
                <strong>Error:</strong> <span id="errorMessage"></span>
              </div>

              <!-- Results Card -->
              <div id="resultsCard" class="tapestry-card">
                <div class="card-header">
                  <h3 class="card-title">Tapestry Segmentation</h3>
                  <span id="zipCodeDisplay" class="zip-code">ZIP</span>
                </div>

                <!-- Demographics -->
                <div class="demographics-grid">
                  <div class="demographic-item">
                    <h4>Total Population</h4>
                    <div id="totalPopulation" class="value">-</div>
                  </div>
                  <div class="demographic-item">
                    <h4>Median Age</h4>
                    <div id="medianAge" class="value">-</div>
                  </div>
                  <div class="demographic-item">
                    <h4>Median Income</h4>
                    <div id="medianIncome" class="value">-</div>
                  </div>
                  <div class="demographic-item">
                    <h4>Home Ownership</h4>
                    <div id="homeOwnership" class="value">-</div>
                  </div>
                </div>

                <!-- Tapestry Segments -->
                <div class="tapestry-segments">
                  <h4>Tapestry Segments</h4>
                  <div id="tapestrySegments">
                    <p style="color: #666; font-style: italic;">Enter a ZIP code to see Tapestry segmentation data</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
          <arcgis-map 
            id="mapView"
            basemap="arcgis/streets-vector" 
            center="-98.5795, 39.8283" 
            zoom="4">
            <arcgis-zoom position="top-left"></arcgis-zoom>
            <arcgis-search position="top-right"></arcgis-search>
            <arcgis-home position="top-left"></arcgis-home>
          </arcgis-map>
        </div>
      </div>
    </div>

    <script>
      // DOM elements
      const zipCodeInput = document.getElementById('zipCodeInput');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const errorMessage = document.getElementById('errorMessage');
      const resultsCard = document.getElementById('resultsCard');
      const zipCodeDisplay = document.getElementById('zipCodeDisplay');
      const totalPopulation = document.getElementById('totalPopulation');
      const medianAge = document.getElementById('medianAge');
      const medianIncome = document.getElementById('medianIncome');
      const homeOwnership = document.getElementById('homeOwnership');
      const tapestrySegments = document.getElementById('tapestrySegments');

      // Event listeners
      analyzeBtn.addEventListener('click', analyzeZipCode);
      zipCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') analyzeZipCode();
      });

      // Analyze ZIP code function
      async function analyzeZipCode() {
        const zipCode = zipCodeInput.value.trim();
        
        if (!zipCode) {
          showError('Please enter a ZIP code');
          return;
        }

        if (!/^\d{5}$/.test(zipCode)) {
          showError('Please enter a valid 5-digit ZIP code');
          return;
        }

        showLoading();
        hideError();
        hideResults();

        try {
          // Get demographic data using GeoEnrichment service
          const data = await getDemographicData(zipCode);
          
          if (data) {
            displayResults(zipCode, data);
            showResults();
          } else {
            showError('No data found for this ZIP code. Please try another ZIP code.');
          }
        } catch (error) {
          console.error('Error analyzing ZIP code:', error);
          showError('Error analyzing ZIP code. Please try again.');
        } finally {
          hideLoading();
        }
      }

      // Get demographic data from GeoEnrichment service
      async function getDemographicData(zipCode) {
        const enrichUrl = "https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver/Geoenrichment/enrich";
        
        // Define study area using ZIP code
        const studyAreas = [{
          sourceCountry: "US",
          layer: "US.ZIP5",
          ids: [zipCode]
        }];
        
        // Request demographic and Tapestry data
        const dataCollections = [
          "KeyUSFacts",           // Basic demographic facts
          "US.TapestrySegmentation" // Tapestry segmentation data
        ];
        
        // Build request parameters
        const params = new URLSearchParams({
          studyAreas: JSON.stringify(studyAreas),
          dataCollections: JSON.stringify(dataCollections),
          f: "json"
        });
        
        // Make request to GeoEnrichment service
        const response = await fetch(`${enrichUrl}?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Process the response
        if (data.results && data.results.length > 0) {
          const result = data.results[0];
          if (result.value && result.value.FeatureSet && result.value.FeatureSet.length > 0) {
            const features = result.value.FeatureSet[0].features;
            if (features && features.length > 0) {
              return features[0].attributes;
            }
          }
        }
        
        return null;
      }

      // Display results
      function displayResults(zipCode, data) {
        // Update ZIP code display
        zipCodeDisplay.textContent = zipCode;
        
        // Update demographics
        totalPopulation.textContent = formatNumber(data.TOTPOP || 'N/A');
        medianAge.textContent = data.MEDIAN_AGE || data.AGE_MEDIAN || 'N/A';
        medianIncome.textContent = formatCurrency(data.MEDIAN_HOUSEHOLD_INCOME || data.INCOME_MEDIAN || 'N/A');
        homeOwnership.textContent = formatPercentage(data.HOME_OWNERSHIP_RATE || data.OWNERSHIP_RATE || 'N/A');
        
        // Update Tapestry segments
        displayTapestrySegments(data);
      }

      // Display Tapestry segments
      function displayTapestrySegments(data) {
        const tapestryFields = Object.keys(data).filter(key => 
          key.includes('Tapestry') || key.includes('Segmentation') || key.includes('Segment')
        );
        
        if (tapestryFields.length > 0) {
          const segmentsHtml = tapestryFields.map(field => {
            const value = data[field];
            if (value && typeof value === 'string' && value.trim() !== '') {
              return `
                <div class="segment-item">
                  <h5>${formatFieldName(field)}</h5>
                  <p>${value}</p>
                </div>
              `;
            }
            return '';
          }).join('');
          
          tapestrySegments.innerHTML = segmentsHtml;
        } else {
          tapestrySegments.innerHTML = `
            <div class="segment-item">
              <h5>Demographic Analysis</h5>
              <p>Based on available demographic data for this ZIP code</p>
            </div>
          `;
        }
      }

      // Utility functions
      function formatNumber(value) {
        if (value === 'N/A' || value === null || value === undefined) return 'N/A';
        return new Intl.NumberFormat().format(value);
      }

      function formatCurrency(value) {
        if (value === 'N/A' || value === null || value === undefined) return 'N/A';
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(value);
      }

      function formatPercentage(value) {
        if (value === 'N/A' || value === null || value === undefined) return 'N/A';
        return `${value}%`;
      }

      function formatFieldName(fieldName) {
        return fieldName
          .replace(/_/g, ' ')
          .replace(/([A-Z])/g, ' $1')
          .replace(/^./, str => str.toUpperCase())
          .trim();
      }

      // UI state functions
      function showLoading() {
        loadingState.style.display = 'block';
        analyzeBtn.disabled = true;
      }

      function hideLoading() {
        loadingState.style.display = 'none';
        analyzeBtn.disabled = false;
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorState.classList.add('active');
      }

      function hideError() {
        errorState.classList.remove('active');
      }

      function showResults() {
        resultsCard.classList.add('active');
      }

      function hideResults() {
        resultsCard.classList.remove('active');
      }
    </script>
  </body>
</html>
